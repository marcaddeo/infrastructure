apiVersion: v1
kind: ConfigMap
metadata:
  name: secret-remapper-script
  namespace: flux-system
data:
  sync.sh: |
    #!/bin/sh
    set -e

    # --- CONFIG ---
    # EXPECTED ENV VARS:
    # SOURCE_SECRET, TARGET_SECRET, KEY_MAP (JSON), GENERATED_KEYS (Space separated)

    echo "Starting Sync: $SOURCE_SECRET -> $TARGET_SECRET"

    # 1. GET CURRENT TARGET (To preserve existing generated keys)
    TARGET_JSON=$(kubectl get secret $TARGET_SECRET -o json 2>/dev/null || true)

    # 2. PREPARE GENERATED KEYS (Idempotent)
    # We build a JSON object of { "key": "base64value" }
    GEN_JSON="{}"

    for key in $GENERATED_KEYS; do
      EXISTING_VAL=""

      # Try to find existing value in target
      if [ ! -z "$TARGET_JSON" ]; then
        EXISTING_VAL=$(echo "$TARGET_JSON" | jq -r --arg k "$key" '.data[$k] // empty')
      fi

      if [ ! -z "$EXISTING_VAL" ]; then
        echo "Key '$key': Preserving existing value."
        VAL="$EXISTING_VAL"
      else
        echo "Key '$key': Generating new value."
        # Generate 32 bytes from urandom and base64 encode it (standard for cookie-secrets)
        # We replace newlines just in case
        VAL=$(head -c 32 /dev/urandom | base64 | tr -d '\n')
      fi

      # Add to our JSON fragment
      GEN_JSON=$(echo "$GEN_JSON" | jq --arg k "$key" --arg v "$VAL" '.[$k] = $v')
    done

    # 3. GET SOURCE SECRET
    SOURCE_JSON=$(kubectl get secret $SOURCE_SECRET -o json 2>/dev/null || true)

    if [ -z "$SOURCE_JSON" ]; then
      echo "Source secret '$SOURCE_SECRET' not found. Skipping."
      exit 0
    fi

    # 4. MERGE AND APPLY
    # Logic:
    # - Take Source JSON
    # - Rename Metadata
    # - Apply Key Map (Remap DB/OIDC keys)
    # - Inject Generated Keys (Cookie Secret)
    # - Clean Metadata

    echo "$SOURCE_JSON" | jq --arg name "$TARGET_SECRET" \
                             --argjson map "$KEY_MAP" \
                             --argjson gen "$GEN_JSON" '
      .metadata = {"name": $name, "namespace": .metadata.namespace} |

      # Remap Source Keys
      reduce ($map | to_entries[]) as $item (.; .data[$item.value] = .data[$item.key]) |

      # Inject Generated/Preserved Keys
      reduce ($gen | to_entries[]) as $item (.; .data[$item.key] = $item.value) |

      # Cleanup unused source keys
      reduce ($map | to_entries[]) as $item (.; if $item.key != $item.value then del(.data[$item.key]) else . end) |

      del(.metadata.uid, .metadata.resourceVersion, .metadata.creationTimestamp, .metadata.ownerReferences)
    ' | kubectl apply -f -

    echo "Sync Complete."
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: secret-remapper
  namespace: flux-system
spec:
  schedule: "* * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: secret-remapper-sa
          containers:
            - name: syncer
              image: bitnami/kubectl:latest
              command: ["/bin/sh", "/scripts/sync.sh"]
              env:
                - name: SOURCE_SECRET
                  value: "capacitor-oidc-credentials"
                - name: TARGET_SECRET
                  value: "oauth2-proxy-creds"
                - name: KEY_MAP
                  value: |
                    {
                      "client_id": "client-id",
                      "client_secret": "client-secret"
                    }
                - name: GENERATED_KEYS
                  value: "cookie-secret redis-password"
              volumeMounts:
                - name: script-vol
                  mountPath: /scripts
          volumes:
            - name: script-vol
              configMap:
                name: secret-remapper-script
                defaultMode: 0755
          restartPolicy: OnFailure
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: secret-remapper-sa
  namespace: flux-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: secret-remapper-role
  namespace: flux-system
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    # "get" needed to read the source
    # "create" needed to make the target initially
    # "patch"/"update" needed to keep it in sync
    verbs: ["get", "list", "create", "patch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: secret-remapper-binding
  namespace: flux-system
subjects:
  - kind: ServiceAccount
    name: secret-remapper-sa
roleRef:
  kind: Role
  name: secret-remapper-role
  apiGroup: rbac.authorization.k8s.io
